// ===============================
// COLLEGE ERP
// ===============================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

////////////////////
/// ENUMS
////////////////////

enum UserRole {
  ADMIN
  HOD
  ACCOUNTANT
}

enum PaymentStatus {
  INITIATED
  SUCCESS
  FAILED
  REFUNDED
}

enum StudentStatus {
  ACTIVE
  SUSPENDED
  PASSED_OUT
  ALUMNI
  DROPOUT
}

enum CertificateType {
  BONAFIDE
  CLC
}

enum CertificateStatus {
  PENDING
  APPROVED
  REJECTED
  ISSUED
}

enum FeeHead {
  TUITION
  EXAM
  INFRASTRUCTURE
  DEVELOPMENT
  CERTIFICATE
  MISC
}

enum AdmissionStatus {
  INITIATED
  PAYMENT_PENDING
  CONFIRMED
  CANCELLED
}

enum SemesterStatus {
  ONGOING
  COMPLETED
  FAILED
  PROMOTED
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum Category {
  GENERAL
  BC_I
  BC_II
  SC
  ST
  EWS
}

enum SubjectType {
  MJC
  MIC
  MDC
  SEC
  VAC
}

////////////////////
/// USERS (ADMIN / STAFF / HOD)
////////////////////

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  name         String
  phone        String?
  role         UserRole @default(HOD) //ACOUNTANT, ADMIN, HOD
  isActive     Boolean  @default(true)

  auditLogs AuditLog[]

  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  AdmissionHistory   AdmissionHistory[]
  Refund             Refund[]
  CertificateRequest CertificateRequest[]
}

////////////////////
/// STUDENTS (SEPARATE AUTH)
////////////////////

model Student {
  id         String    @id @default(uuid())
  reg_no     String?   @unique
  email      String    @unique
  uan_no     String    @unique
  class_roll String?
  name       String
  phone      String
  dob        DateTime?

  fatherName String?
  gender     Gender?
  category   Category?

  address  String?
  photoUrl String?

  isDeleted Boolean       @default(false)
  status    StudentStatus @default(ACTIVE)

  courseId  String
  sessionId String

  course  Course  @relation(fields: [courseId], references: [id])
  session Session @relation(fields: [sessionId], references: [id])

  semesters    StudentSemester[]
  payments     Payment[]
  certificates CertificateRequest[]
  documents    StudentDocument[]
  admissions   Admission[]

  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  StudentSubject StudentSubject[]
}

////////////////////
/// STUDENT DOCUMENT
////////////////////

model StudentDocument {
  id                String  @id @default(uuid())
  studentId         String
  type              String // Aadhar, Marksheet, TC
  fileUrl           String
  verified          Boolean @default(false)
  verificationNotes String?

  student Student @relation(fields: [studentId], references: [id])
}

////////////////////
/// DEPARTMENTS , COURSES & SUBJECTs
////////////////////

model Department {
  id          String  @id @default(uuid())
  name        String
  code        String? @unique
  description String?

  courses Course[]

  admissionWindow    AdmissionWindow[]
  admission          Admission[]
  CertificateRequest CertificateRequest[]
}

model Course {
  id            String @id @default(uuid())
  code          String @unique
  name          String
  durationYears Int
  departmentId  String

  department Department @relation(fields: [departmentId], references: [id])

  sessions        CourseSession[]
  students        Student[]
  subjects        Subject[]
  semesters       Semester[]
  admission       Admission[]
  admissionWindow AdmissionWindow[]
}

model Subject {
  id   String      @id @default(uuid())
  code String
  name String
  //credit Int
  type SubjectType

  semesterId String
  courseId   String

  semester       Semester         @relation(fields: [semesterId], references: [id])
  course         Course           @relation(fields: [courseId], references: [id])
  StudentSubject StudentSubject[]

  @@unique([code, courseId, semesterId])
}

model StudentSubject {
  id         String @id @default(uuid())
  studentId  String
  subjectId  String
  semesterId String

  student  Student  @relation(fields: [studentId], references: [id])
  subject  Subject  @relation(fields: [subjectId], references: [id])
  semester Semester @relation(fields: [semesterId], references: [id])

  @@unique([studentId, subjectId, semesterId])
}

////////////////////
/// SESSION , STUDENT SEMESTER & SEMESTER
////////////////////

model Session {
  id        String @id @default(uuid())
  name      String // 2023-2026
  startYear Int
  endYear   Int

  courses  CourseSession[]
  students Student[]
}

model Semester {
  id       String @id @default(uuid())
  number   Int
  courseId String

  course           Course            @relation(fields: [courseId], references: [id])
  subjects         Subject[]
  studentSemesters StudentSemester[]
  StudentSubject   StudentSubject[]
}

model CourseSession {
  id        String @id @default(uuid())
  courseId  String
  sessionId String

  course  Course  @relation(fields: [courseId], references: [id])
  session Session @relation(fields: [sessionId], references: [id])

  @@unique([courseId, sessionId])
}

model StudentSemester {
  id         String         @id @default(uuid())
  studentId  String
  semesterId String
  status     SemesterStatus
  feePaid    Boolean        @default(false)
  startDate  DateTime
  endDate    DateTime?

  student  Student  @relation(fields: [studentId], references: [id])
  semester Semester @relation(fields: [semesterId], references: [id])

  @@unique([studentId, semesterId])
}

////////////////////
/// ADMISSIONS
////////////////////

model AdmissionWindow {
  id           String   @id @default(uuid())
  title        String //"BSc Admission 2025"
  courseId     String
  departmentId String
  startDate    DateTime
  endDate      DateTime
  enabled      Boolean  @default(false)

  course     Course     @relation(fields: [courseId], references: [id])
  department Department @relation(fields: [departmentId], references: [id])
}

model Admission {
  id           String  @id @default(uuid())
  studentId    String
  courseId     String
  departmentId String?

  meritListType  String? // MeritList_03 / 04 / 05
  profileNo      String?
  confidentialNo String?
  admissionNo    String?

  status AdmissionStatus @default(INITIATED)

  student    Student     @relation(fields: [studentId], references: [id])
  course     Course      @relation(fields: [courseId], references: [id])
  department Department? @relation(fields: [departmentId], references: [id])

  payments Payment[]
  history  AdmissionHistory[]

  @@index([studentId, courseId])
}

model AdmissionHistory {
  id          String          @id @default(uuid())
  admissionId String
  fromStatus  AdmissionStatus
  toStatus    AdmissionStatus
  changedById String
  changedAt   DateTime        @default(now())
  notes       String?

  admission Admission @relation(fields: [admissionId], references: [id])
  changedBy User      @relation(fields: [changedById], references: [id])
}

////////////////////
/// PAYMENTS & RECEIPTS
////////////////////

model Payment {
  id          String  @id @default(uuid())
  studentId   String
  admissionId String?

  totalAmount Decimal
  status      PaymentStatus
  gateway     String
  txnId       String        @unique
  referenceNo String?
  bankTxnNo   String?

  receiptNo  String  @unique
  receiptUrl String?

  createdAt DateTime @default(now())

  student   Student          @relation(fields: [studentId], references: [id])
  admission Admission?       @relation(fields: [admissionId], references: [id])
  breakups  PaymentBreakup[]
  receipt   Receipt[]
  refund    Refund?
}

model PaymentBreakup {
  id        String  @id @default(uuid())
  paymentId String
  head      FeeHead
  amount    Decimal

  payment Payment @relation(fields: [paymentId], references: [id])

  @@index([head])
}

model Receipt {
  id        String   @id @default(uuid())
  paymentId String
  type      String // ADMISSION / EXAM / CERTIFICATE
  pdfUrl    String
  issuedAt  DateTime @default(now())

  payment Payment @relation(fields: [paymentId], references: [id])
}

model Refund {
  id           String   @id @default(uuid())
  paymentId    String   @unique
  amount       Decimal
  reason       String
  refundedById String
  refundedAt   DateTime @default(now())

  payment    Payment @relation(fields: [paymentId], references: [id])
  refundedBy User    @relation(fields: [refundedById], references: [id])
}

////////////////////
/// CERTIFICATES
////////////////////

model CertificateRequest {
  id           String            @id @default(uuid())
  studentId    String
  type         CertificateType
  purpose      String?
  departmentId String
  status       CertificateStatus @default(PENDING)

  approvedById String?
  issuedAt     DateTime?
  pdfUrl       String?

  student    Student    @relation(fields: [studentId], references: [id])
  department Department @relation(fields: [departmentId], references: [id])
  approvedBy User?      @relation(fields: [approvedById], references: [id])
}

////////////////////
/// CMS CONTENT
////////////////////

model Gallery {
  id        String   @id @default(uuid())
  title     String
  coverUrl  String?
  createdAt DateTime @default(now())
}

model News {
  id          String  @id @default(uuid())
  title       String
  body        String
  isPublished Boolean @default(false)
  url         String?
}

model Notice {
  id    String  @id @default(uuid())
  title String
  body  String
  url   String?
}

///////////////////
/// AUDIT LOG
///////////////////

model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  action    String
  entity    String
  entityId  String
  payload   Json?
  ipAddress String?
  userAgent String?
  timestamp DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

////////////////////
/// BLACKLISTED TOKENS
////////////////////

model BlacklistedToken {
  id        String   @id @default(uuid())
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
}
